# 서비스 배포

이제 백엔드 서비스를 구현했으니까 서비스를 배포해 봅시다.

배포란 유저들이 실제로 서비스를 쓸 수 있게 하는 것인데요. 코드를 서버 컴퓨터로 옮겨서 백엔드 서버가 항상 실행되도록 할 겁니다. 지금은 개인 컴퓨터에서 `npm run dev`나 `npm start`를 해야 서버가 실행되는데 개인 컴퓨터에 항상 서버를 켜 놓을 수는 없겠죠? 그리고 개인 컴퓨터에서 실행되는 서버는 다른 기계에서는 접근할 수 없습니다.

배포를 하기 전에 해야 하는 작업이 두 가지 있습니다.

1. 환경 변수 설정
2. CORS 설정

위 작업들은 먼저 진행하고 서비스를 배포해 보겠습니다.

# 환경 변수란?

환경 변수(Environment Variable)는 프로그램이 실행되는 환경과 관련이 있는 변수들입니다. 예를 들어 `env.js` 파일에 있는 `DATABASE_URL` 변수 기억나시죠? 보통 개발을 할 때와 서비스를 운영할 때는 서로 다른 데이터베이스를 사용하기 때문에 환경에 따라 `DATABASE_URL` 값이 달라집니다. 포트 번호도 마찬가지인데요. 개발을 할 때는 3000번을 많이 쓰지만 서비스를 운영할 때는 http나 https에 해당하는 80 또는 443번을 사용합니다. 이번 레슨에서는 `dotenv`라는 라이브러리를 써서 환경 변수를 다뤄 보겠습니다.

# `dotenv` 라이브러리 사용하기

npm으로 `dotenv` 라이브러리를 설치하세요.

터미널

```bash
npm install dotenv
```

그리고 `.env`라는 파일을 만들고 안에 아래와 같이 작성해 주세요.

.env
```
DATABASE_URL="mongodb+srv://<username>:<password>@todo-api.l0aepsl.mongodb.net/todo-api?retryWrites=true&w=majority"
PORT=3000
```

`DATABASE_URL`은 `env.js` 파일에 있던 값을 그대로 가져오시면 됩니다(`.env` 파일에서는 큰따옴표를 사용하세요). 다 작성하셨다면 `env.js` 파일은 삭제하셔도 됩니다.

그리고 `.env` 파일에서 환경 변수를 가져오려면 코드를 아래와 같이 수정하면 됩니다.

app.js(수정 전)

```js
// ...

import { DATABASE_URL } from './env.js';

// ...

mongoose.connect(DATABASE_URL).then(() => console.log('Connected to DB'));

// ...

app.listen(3000, () => console.log('Server Started'));

```

app.js(수정 후)
```js
// ...

import * as dotenv from 'dotenv';
dotenv.config();

// ...

mongoose.connect(process.env.DATABASE_URL).then(() => console.log('Connected to DB'));

// ...

app.listen(process.env.PORT || 3000, () => console.log('Server Started'));

```

`dotenv` 라이브러리를 import하고 `config()` 함수를 호출하면 `.env` 파일에 있는 변수들이 `process.env`라는 객체에 로딩됩니다. `dotenv`를 import할 때는 위와 같은 방식이 권장된다는 점도 기억해 주세요. `process.env.PORT || 3000` 이 부분은 만약 `PORT` 환경 변수가 없다면 `3000`을 사용하는 겁니다.

`seed.js` 파일도 똑같이 바꿔 주세요.

seed.js(수정 전)
```js
// ...

import { DATABASE_URL } from './env.js';

// ...

mongoose.connect(DATABASE_URL);


```

seed.js(수정 후)
```js
// ...

import * as dotenv from 'dotenv';
dotenv.config();

// ...

mongoose.connect(process.env.DATABASE_URL);

```

수정 후 `npm run seed`, `npm run dev` 커맨드가 잘 작동하는지 확인해 보세요!

`env.js`같은 일반 자바스크립트 파일 대신 `dotenv`를 사용하면 몇 가지 장점이 있습니다.

첫 번째는 환경 변수를 더 안전하게 관리할 수 있다는 점입니다. 환경 변수에는 유저네임이나 비밀번호 같은 민감한 정보가 들어가는 경우가 많죠? 이름이 `.`으로 시작하는 dotfile은 일반 파일 탐색기로는 안 보이기 때문에 노출 가능성이 적습니다. 그리고 코드를 GitHub 같은 온라인 저장소에 올릴 때도 `.env` 파일은 제외되도록 설정합니다.

두 번째 장점은 배포 시에 굉장히 편리하다는 점입니다. 배포 서비스는 서비스 내에서 환경 변수를 설정할 수 있게 하는데요. 그러면 서비스가 알아서 `.env` 파일을 생성하거나 다른 방식으로 `process.env`에 환경 변수를 전달합니다. 그래서 로컬과 프로덕션 환경에서 완전히 똑같은 코드를 사용해도 각 환경에 맞는 환경 변수 값이 주입됩니다.

# CORS 오류

지금 상태로 배포를 하면 프론트엔드에서 배포된 API를 활용할 수 없습니다. 프론트엔드(자바스크립트 코드)에서 API에 리퀘스트를 보내면 `CORS Error`라는 게 발생하는데요.

```bash
Access to fetch at <API 주소> from origin <프론트엔드 주소> has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

이걸 해결하려면 CORS(Cross-Origin Resource Sharing)을 허용해야 합니다. 지금은 잘 안 와닿으실 수도 있지만 '프론트엔드 코드에서 배포된 API를 사용할 수 있게 하려면 CORS를 허용해야 한다' 이렇게 이해하시면 됩니다. 자세한 내용은 [CORS 튜토리얼](https://www.codeit.kr/tutorials/95/CORS%EB%9E%80%3F)에 정리돼 있으니까 궁금하신 분들은 한번 읽어보세요.

# CORS 허용하기

npm에서 `cors`라는 패키지를 설치하세요.

터미널

```bash
npm install cors
```

`app.js` 파일에서 `cors`를 import하고 `app.use(cors())`를 추가하세요.

app.js

```js
// ...

import cors from 'cors';

// ...

const app = express();

app.use(cors());
app.use(express.json());
```

그러면 CORS가 허용돼서 프론트엔드 코드에서 API를 사용할 수 있습니다.

참고로 특정 주소에 대해서만 CORS를 허용해도 됩니다. 예를 들어 프론트엔드를 개발할 때는 `http://127.0.0.1:3000`, 배포 시에는 `https://my-todo.com`이라는 주소를 사용한다고 할게요. 그러면 이 두 주소에 대해서만 CORS를 허용하는 게 더 안전합니다.

app.js

```js
const app = express();

const corsOptions = {
  origin: ['http://127.0.0.1:3000', 'https://my-todo.com'],
};

app.use(cors(corsOptions));
app.use(express.json());

```

옵션 객체의 `origin` 프로퍼티에 프론트엔드 주소들을 추가하시면 됩니다.


# render

우리는 [render](https://render.com/)라는 서비스를 이용해서 백엔드 서버를 배포해 볼 겁니다. render는 배포의 많은 과정을 자체적으로 처리해 주기 때문에 아주 쉽게 배포를 할 수 있습니다. render로 어떻게 배포를 하는지 한 단계씩 알아봅시다.

# GitHub에 코드 업로드하기

GitHub는 유명한 온라인 코드 저장소입니다. 여기서는 GitHub에 리포지토리(저장소)를 새로 생성하고 프로젝트 코드를 업로드하는 과정을 설명하는데요. 이미 Git과 GitHub에 익숙하시고 Git과 GitHub를 사용하시고 있으시다면 이 부분은 읽지 않고 넘어가시면 됩니다.

아래 가이드에 따라서 Git을 설치해 주세요.

- [[Git 설치 (Windows)]](https://www.codeit.kr/tutorials/56/installing-git-on-windows)
- [[Git 설치 (Mac)]](https://www.codeit.kr/tutorials/58/installing-git-on-mac)

Git을 설치했다면 GitHub에도 가입해 주세요. [Github 홈페이지](https://github.com/)로 접속해서 오른쪽 상단에 있는 Sign up을 눌러서 가입하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=github.com_.png&name=github.com_.png)

가입을 완료하고 로그인하면 이런 화면이 보입니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=github.com_%20(2).png&name=github.com_+%25282%2529.png)

GitHub에 리포지토리라는 걸 하나 만들겠습니다. 리포지토리는 쉽게 말해서 원격 저장소 같은 건데요. 코드를 GitHub에 업로드하는 거라고 이해하시면 됩니다. 메인화면에서 왼쪽에 있는 New 또는 Create repository 버튼을 클릭하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled.png&name=Untitled.png)

Repository name에 적당한 이름을 적어 주세요. 그리고 Create repository를 클릭해 주세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(1).png&name=Untitled+%25281%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(2).png&name=Untitled+%25282%2529.png)

리포지토리가 만들어지면 이런 화면이 뜹니다. 잠시 후 이 화면으로 돌아와서 아래 있는 코드를 복사할 겁니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(3).png&name=Untitled+%25283%2529.png)

이제 VS Code로 터미널을 열고 아래 커맨드를 하나씩 실행해 주세요.

`git init echo 'node_modules/\n.env\n*.http\n*.log\n*.gz\n.DS_Store' > .gitignore`

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(4).png&name=Untitled+%25284%2529.png)

두 번째 줄은 Git 파일 관리에서 제외할 것들을 명시하는 `.gitignore`라는 파일을 생성하는 겁니다. `node_modules` 디렉토리, `.env` 파일, `.http` 파일, 그리고 다른 것들 몇 가지는 GitHub에 올릴 필요가 없기 때문에 제외했습니다. `node_modules`는 엄청나게 많은 용량을 차지하고 `package.json`에 있는 `dependencies` 목록을 보고 패키지들을 설치할 수 있기 때문에 `node_modules` 자체를 업로드할 필요가 없습니다.

그런 다음 좌측 메뉴에 브랜치처럼 생긴 Source Control을 선택하고 Changes 옆에 있는 + 버튼을 클릭하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(5).png&name=Untitled+%25285%2529.png)

그럼 아래처럼 Staged Changes에 파일들이 추가됩니다. 그러고 나서 위쪽에 커밋 메시지를 적어 줄 건데요. 자유롭게 쓰셔도 되지만 저는 `First Commit` 이라고 간단히 적어 주었습니다. 그러고 나서 아래에 있는 Commit 버튼을 누르세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(6).png&name=Untitled+%25286%2529.png)

그리고 아까 GitHub 페이지로 돌아가서 코드를 복사하고 터미널에 붙여 넣은 다음 엔터를 누르세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(7).png&name=Untitled+%25287%2529.png)

이 과정에서 권한을 요청할 수도 있는데요. Allow → Authorize-Visual-Studio-Code → Open을 클릭해서 허용해 주세요. 만약에 이전에 깃허브를 사용하신 적이 있는 분들은 이미 허용이 되어 있을 겁니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(8).png&name=Untitled+%25288%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(9).png&name=Untitled+%25289%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(10).png&name=Untitled+%252810%2529.png)

그럼 이렇게 코드를 GitHub 리포지토리에 코드를 푸시하게 됩니다. 참고로 푸시한다는 것은 리포지토리에다가 코드를 업로드하는 거라고 이해하시면 됩니다. 아래처럼 `branch 'main' set up to track 'origin/main'`이라는 메시지가 나오면 됩니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(11).png&name=Untitled+%252811%2529.png)

GitHub에서 새로고침해 보면 이렇게 코드가 업로드돼 있습니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(12).png&name=Untitled+%252812%2529.png)

# render 가입 + GitHub 연동하기

render에 [회원가입](https://dashboard.render.com/register?next=%2F)을 해 주세요. 이미 회원이시라면 Sign in 링크를 눌러서 로그인을 해 주세요. 소셜 로그인을 이용하셔도 됩니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(13).png&name=Untitled+%252813%2529.png)

처음 가입한다면 가입 후 이메일 인증을 완료해 주세요.

인증을 완료하면 [대시보드](https://dashboard.render.com/)로 이동합니다. 여기서 New → Web Service를 클릭하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(14).png&name=Untitled+%252814%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(15).png&name=Untitled+%252815%2529.png)

Connect GitHub 버튼을 클릭하고 Authorize Render를 클릭하세요. 만약 웹 브라우저에서 GitHub으로 로그인이 안 된 상태라면 먼저 로그인 화면이 뜰 겁니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(16).png&name=Untitled+%252816%2529.png)

다음 화면에서는 All repositories를 선택하거나 Only select repositories → todo-api 리포지토리를 선택한 후 Install을 클릭하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(17).png&name=Untitled+%252817%2529.png)

다시 New Web Service 화면으로 돌아가 보면 `todo-api` 리포지토리가 보입니다. 실제로 웹 서비스를 생성하기 전에 프로덕션 환경에 사용할 데이터베이스를 만들어 주겠습니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(18).png&name=Untitled+%252818%2529.png)

# 프로덕션 DB 만들기

[MongoDB Atlas](https://www.mongodb.com/atlas/database)에서 액세스 설정을 하고 프로덕션 데이터베이스를 만들 겁니다. 먼저 좌측 메뉴에 있는 Network Access를 클릭하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(19).png&name=Untitled+%252819%2529.png)

Add IP Addresses를 클릭하세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(20).png&name=Untitled+%252820%2529.png)

Allow access from anywhere를 클릭하고 Confirm 버튼을 누르세요. 배포된 서버에서도 접속할 수 있어야 하기 때문입니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(21).png&name=Untitled+%252821%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(22).png&name=Untitled+%252822%2529.png)

그런 다음에는 프로덕션 데이터베이스를 하나 만듭시다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(23).png&name=Untitled+%252823%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(24).png&name=Untitled+%252824%2529.png)

프로덕션 데이터베이스에도 테스트 데이터를 넣을 수 있는데요. 배포 환경에서는 `npm run seed` 같은 커맨드를 실행하기 어렵기 때문에 Atlas에서 직접 삽입하는 게 가장 쉽습니다. Insert Documents를 클릭하고 코드 블록에 있는 JSON을 복사해서 붙여 넣으시면 됩니다.

```json
[
  {
    "title": "파이썬 공부",
    "description": "프로그래밍 시작하기 in Python 토픽 끝내기",
    "isComplete": false,
    "createdAt": "2023-03-23T06:34:11.617Z",
    "updatedAt": "2023-03-23T06:34:11.617Z"
  },
  {
    "title": "독서",
    "description": "30 페이지",
    "isComplete": false,
    "createdAt": "2023-03-23T06:34:10.617Z",
    "updatedAt": "2023-03-23T06:34:10.617Z"
  },
  {
    "title": "집 청소",
    "isComplete": true,
    "createdAt": "2023-03-23T06:34:09.617Z",
    "updatedAt": "2023-03-23T06:34:09.617Z"
  },
  {
    "title": "리액트 공부",
    "description": "Tic Tac Toe 게임 완성하기",
    "isComplete": true,
    "createdAt": "2023-03-23T06:34:08.617Z",
    "updatedAt": "2023-03-23T06:34:08.617Z"
  },
  {
    "title": "30분 운동",
    "isComplete": false,
    "createdAt": "2023-03-23T06:34:07.617Z",
    "updatedAt": "2023-03-23T06:34:07.617Z"
  }
]
```

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(25).png&name=Untitled+%252825%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(26).png&name=Untitled+%252826%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(27).png&name=Untitled+%252827%2529.png)

잠시 후 이 데이터베이스에 대한 URL을 render에서 사용할 겁니다.

# render 웹 서비스 생성하기

[대시보드](https://dashboard.render.com/) → New → Web Service로 들어가서 `todo-api` 리포지토리 옆에 있는 Connect 버튼을 클릭해 주세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(28).png&name=Untitled+%252828%2529.png)

그리고 아래와 같이 세팅을 해 주세요.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(29).png&name=Untitled+%252829%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(30).png&name=Untitled+%252830%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(31).png&name=Untitled+%252831%2529.png)

그리고 아래 쪽에서 환경 변수들을 입력하고 Create Web Service 버튼을 클릭하세요.

- `.env` 파일에서 사용하던 `DATABASE_URL` 값을 복사해서 경로 부분을 `todo-api-prod`로 바꿔 주세요.
- `PORT`는 자동으로 설정되기 때문에 따로 설정할 필요 없습니다.
- `NODE_VERSION`으로 Node.js 버전을 설정합니다. 로컬에서 사용하던 Node.js 버전과 동일한 메이저 버전으로 설정합니다(`18.x`는 모두 괜찮습니다).

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=1&directory=Untitled%2520(32).png&name=Untitled%252520%252832%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(33).png&name=Untitled+%252833%2529.png)

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(34).png&name=Untitled+%252834%2529.png)

이제 자동으로 배포가 진행됩니다. 위에서 설정했던 Build Command와 Start Command를 실행해 주는 겁니다. 그리고 위에서 Auto-Deploy를 선택했기 때문에 새로운 코드를 작성해서 GitHub에 push를 할 때마다 render가 자동으로 배포를 해 줍니다.

아래와 같이 Live 상태가 보이면 배포가 성공한 겁니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(35).png&name=Untitled+%252835%2529.png)

이제 페이지 위쪽에 있는 주소로 API를 호출할 수 있습니다. 예를 들어 `/tasks`는 `https://todo-api-siv0.onrender.com/tasks`로 리퀘스트를 보내면 됩니다.

![](https://bakey-api.codeit.kr/api/files/resource?root=static&seqId=6491&version=&directory=Untitled%20(36).png&name=Untitled+%252836%2529.png)

여러분이 만든 구독 관리 API도 배포하고 싶다면 똑같은 방식으로 할 수 있습니다. 필요하신 분들은 코드잇 실행기에서 코드를 다운로드하세요.